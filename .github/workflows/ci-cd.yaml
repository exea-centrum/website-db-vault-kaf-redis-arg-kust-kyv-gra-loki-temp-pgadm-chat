name: CI/CD Build & Deploy

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read
  packages: write
  security-events: write

jobs:
  code-quality:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 black pylint bandit safety mypy pytest pytest-cov radon coverage
          pip install -r app/requirements.txt

      - name: Run flake8 linting
        run: |
          flake8 app/ --count --max-complexity=10 --max-line-length=127 --statistics --show-source

      - name: Run black code formatting check
        run: |
          black --check app/

      - name: Run pylint analysis
        run: |
          pylint app/ --exit-zero --output-format=json:pylint-report.json || true

      - name: Run bandit security scanning
        run: |
          bandit -r app/ -f json -o bandit-report.json || true

      - name: Run safety dependency check
        run: |
          safety check -r app/requirements.txt --json > safety-report.json || true

      - name: Run mypy type checking
        run: |
          mypy app/ --ignore-missing-imports --html-report mypy-report

      - name: Calculate code metrics with radon
        run: |
          echo "### Code Complexity Metrics ðŸ“Š" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          radon cc app/ -s >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

          echo "### Maintainability Index ðŸ“ˆ" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          radon mi app/ -s >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Run tests with coverage
        run: |
          cd app
          python -m pytest --cov=. --cov-report=xml --cov-report=html --cov-report=term-missing

      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: |
            app/coverage.xml
            app/htmlcov/

      - name: Pytest coverage comment
        uses: MishaKav/pytest-coverage-comment@main
        with:
          pytest-coverage-path: app/coverage.xml
          title: pytest Coverage Report
          badge-title: coverage
          hide-badge: false
          hide-report: false
          create-new-comment: false
          hide-comment: false

      - name: HTML validation
        uses: Cyb3r-Jak3/html5validator-action@v1.1.0
        with:
          root: app/templates

      - name: Validate Dockerfile
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: Dockerfile

      - name: YAML validation
        uses: actions/desktop/yml-validator@v1
        with:
          file: manifests/base/

      - name: Upload code quality reports
        uses: actions/upload-artifact@v4
        with:
          name: code-quality-reports
          path: |
            bandit-report.json
            safety-report.json
            pylint-report.json
            app/mypy-report/

  advanced-analysis:
    runs-on: ubuntu-latest
    needs: code-quality
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install analysis tools
        run: |
          pip install vulture interrogate dodgy dodgy

      - name: Run vulture (dead code detection)
        run: |
          vulture app/ --min-confidence 80 || true

      - name: Run interrogate (docstring coverage)
        run: |
          interrogate app/ --verbose || true

      - name: Run dodgy (secrets detection)
        run: |
          dodgy app/ || true

      - name: Generate code complexity visualization
        run: |
          pip install pygments
          echo "## Code Quality Overview ðŸŽ¯" >> $GITHUB_STEP_SUMMARY
          echo "### Files with Highest Complexity" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          find app/ -name "*.py" -exec wc -l {} + | sort -rn | head -10 >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  security-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run CodeQL analysis
        uses: github/codeql-action/analyze@v3
        with:
          languages: python

      - name: Run TruffleHog secret scanning
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.base_ref }}
          head: ${{ github.sha }}

      - name: Run Gitleaks secret scanning
        uses: gitleaks/gitleaks-action@v2
        env:
          GITLEAKS_VERSION: v8.18.0

  container-security:
    runs-on: ubuntu-latest
    needs: code-quality
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "fs"
          scan-ref: "."
          format: "sarif"
          output: "trivy-results.sarif"

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: "trivy-results.sarif"

      - name: Run Docker image security scan
        run: |
          # Build image and scan
          docker build -t app:latest .
          trivy image app:latest --format table --exit-code 0

  kubernetes-validation:
    runs-on: ubuntu-latest
    needs: code-quality
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Kubernetes tools
        run: |
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl

          wget https://github.com/instrumenta/kubeval/releases/latest/download/kubeval-linux-amd64.tar.gz
          tar xf kubeval-linux-amd64.tar.gz
          sudo mv kubeval /usr/local/bin

          # Install kube-score
          wget https://github.com/zegl/kube-score/releases/download/v1.17.0/kube-score_1.17.0_linux_amd64.tar.gz
          tar xvf kube-score_1.17.0_linux_amd64.tar.gz
          sudo mv kube-score /usr/local/bin/

      - name: Validate Kubernetes manifests
        run: |
          kubeval manifests/base/ --ignore-missing-schemas

      - name: Score Kubernetes manifests
        run: |
          kube-score score manifests/base/ || true

      - name: Check Kubernetes syntax
        run: |
          kubectl apply --dry-run=client -k manifests/base/

  build-and-push:
    runs-on: ubuntu-latest
    needs:
      [
        code-quality,
        advanced-analysis,
        container-security,
        kubernetes-validation,
      ]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_PAT }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/exea-centrum/website-db-vault-kaf-redis-arg-kust-kyv-gra-loki-temp-pgui
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix={{branch}}-

      - name: Build and push image
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=registry,ref=ghcr.io/exea-centrum/website-db-vault-kaf-redis-arg-kust-kyv-gra-loki-temp-pgui:latest
          cache-to: type=inline,mode=max
          build-args: |
            BUILDKIT_INLINE_CACHE=1

      - name: Generate SBOM
        uses: anchore/sbom-action@v0
        with:
          image: ghcr.io/exea-centrum/website-db-vault-kaf-redis-arg-kust-kyv-gra-loki-temp-pgui:latest

  quality-gate:
    runs-on: ubuntu-latest
    needs: [code-quality, security-scan]
    steps:
      - name: Quality Gate Check
        run: |
          echo "## Quality Gate Results âœ…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Passed Checks:" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Code linting and formatting" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Security scanning" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Dependency checking" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Test coverage" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Container security" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**All quality checks passed! Ready for deployment.** ðŸš€" >> $GITHUB_STEP_SUMMARY

  deploy-preview:
    runs-on: ubuntu-latest
    needs: [build-and-push, quality-gate]
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to preview environment
        run: |
          echo "Deploying preview environment for PR #${{ github.event.pull_request.number }}"
          # Add your preview deployment logic here

  notifications:
    runs-on: ubuntu-latest
    needs: [build-and-push, security-scan]
    if: always()
    steps:
      - name: Notify workflow status
        uses: ravsamhq/notify-slack-action@v2
        if: always()
        with:
          status: ${{ job.status }}
          notification_title: "CI/CD Pipeline - {workflow}"
          message_format: "{emoji} *{workflow}* {status_message} in <{repository_url}|{repo}>"
          footer: "Completed at {time}"
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Create GitHub Deployment
        uses: actions/github-script@v7
        if: success()
        with:
          script: |
            github.rest.repos.createDeployment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.sha,
              environment: 'production',
              auto_merge: false,
              required_contexts: []
            })
